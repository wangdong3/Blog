<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多线程 | 文档管理</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="文档管理">
    
    <link rel="preload" href="/blog/assets/css/0.styles.d7574f63.css" as="style"><link rel="preload" href="/blog/assets/js/app.c61f9dc1.js" as="script"><link rel="preload" href="/blog/assets/js/2.388d52cb.js" as="script"><link rel="preload" href="/blog/assets/js/7.08c24d6d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e48886a1.js"><link rel="prefetch" href="/blog/assets/js/11.0db0625b.js"><link rel="prefetch" href="/blog/assets/js/12.f1057769.js"><link rel="prefetch" href="/blog/assets/js/13.b442abea.js"><link rel="prefetch" href="/blog/assets/js/14.daba5dbf.js"><link rel="prefetch" href="/blog/assets/js/15.c8b8c48c.js"><link rel="prefetch" href="/blog/assets/js/16.7215a435.js"><link rel="prefetch" href="/blog/assets/js/17.2fc8aa9b.js"><link rel="prefetch" href="/blog/assets/js/18.616d526d.js"><link rel="prefetch" href="/blog/assets/js/19.1c4d1a0e.js"><link rel="prefetch" href="/blog/assets/js/20.29879dee.js"><link rel="prefetch" href="/blog/assets/js/21.1d2b8804.js"><link rel="prefetch" href="/blog/assets/js/22.d0629f3d.js"><link rel="prefetch" href="/blog/assets/js/23.93a8ebaf.js"><link rel="prefetch" href="/blog/assets/js/24.324df21c.js"><link rel="prefetch" href="/blog/assets/js/25.b6c9075c.js"><link rel="prefetch" href="/blog/assets/js/26.99b267df.js"><link rel="prefetch" href="/blog/assets/js/27.95b0c3cd.js"><link rel="prefetch" href="/blog/assets/js/28.d14ae9b5.js"><link rel="prefetch" href="/blog/assets/js/29.43834437.js"><link rel="prefetch" href="/blog/assets/js/3.7cefba26.js"><link rel="prefetch" href="/blog/assets/js/30.bb384616.js"><link rel="prefetch" href="/blog/assets/js/31.20f86835.js"><link rel="prefetch" href="/blog/assets/js/32.c742083f.js"><link rel="prefetch" href="/blog/assets/js/33.b2366c8c.js"><link rel="prefetch" href="/blog/assets/js/34.dd52f826.js"><link rel="prefetch" href="/blog/assets/js/35.17416a72.js"><link rel="prefetch" href="/blog/assets/js/36.ff166262.js"><link rel="prefetch" href="/blog/assets/js/4.2f1c3a5f.js"><link rel="prefetch" href="/blog/assets/js/5.4c55088b.js"><link rel="prefetch" href="/blog/assets/js/6.c9d0387c.js"><link rel="prefetch" href="/blog/assets/js/8.f72ad2ba.js"><link rel="prefetch" href="/blog/assets/js/9.c27fcf06.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d7574f63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="文档管理" class="logo"> <span class="site-name can-hide">文档管理</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  Share
</a></div><div class="nav-item"><a href="http://blog.csdn.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/wangdong3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  Share
</a></div><div class="nav-item"><a href="http://blog.csdn.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/wangdong3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/share/java/多线程.html" class="active sidebar-link">多线程</a></li><li><a href="/blog/share/java/Java8.html" class="sidebar-link">Java8</a></li><li><a href="/blog/share/java/单元测试.html" class="sidebar-link">单元测试</a></li><li><a href="/blog/share/java/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/blog/share/java/JMM.html" class="sidebar-link">JVM内存模型</a></li><li><a href="/blog/share/java/设计模式.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="多线程">多线程</h1> <h2 id="一、线程">一、线程</h2> <blockquote><p>线程是<code>CPU</code>资源调度的基本单位</p></blockquote> <h3 id="线程与java线程">线程与<code>java</code>线程</h3> <h4 id="实现线程的方式">实现线程的方式</h4> <p>（1）内核线程实现，调度器对线程进行调度，将线程任务映射到各个处理器执行</p> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
a1<span class="token text string">(cpu)</span><span class="token arrow operator">---</span>b<span class="token text string">(线程调度器)</span>
a2<span class="token text string">(cpu)</span><span class="token arrow operator">---</span>b
a3<span class="token text string">(cpu)</span><span class="token arrow operator">---</span>b
b<span class="token arrow operator">---</span>c1<span class="token text string">(内核线程)</span>
b<span class="token arrow operator">---</span>c2<span class="token text string">(内核线程)</span>
b<span class="token arrow operator">---</span>c3<span class="token text string">(内核线程)</span>
b<span class="token arrow operator">---</span>c4<span class="token text string">(内核线程)</span>
b<span class="token arrow operator">---</span>c5<span class="token text string">(内核线程)</span>
b<span class="token arrow operator">---</span>c6<span class="token text string">(内核线程)</span>
c1<span class="token arrow operator">-.-</span>d1<span class="token text string">(线程)</span>
c2<span class="token arrow operator">-.-</span>d2<span class="token text string">(线程)</span>
c3<span class="token arrow operator">-.-</span>d3<span class="token text string">(线程)</span>
c4<span class="token arrow operator">-.-</span>d4<span class="token text string">(线程)</span>
c5<span class="token arrow operator">-.-</span>d5<span class="token text string">(线程)</span>
c6<span class="token arrow operator">-.-</span>d6<span class="token text string">(线程)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>（2）用户线程实现</p> <p>线程的创建，销毁，切换和调度这些操作都由用户程序自己处理，不需要系统内核的支持，实现比较复杂</p> <p>（3）混合实现</p> <p>多对多的线程模型</p> <h4 id="java线程的实现"><code>java</code>线程的实现</h4> <p>操作系统支持怎样的线程模型，很大程度上也会影响<code>java虚拟机</code>的线程怎么映射的，这一点在不同个平台上很难达到一致，因此，<code>java虚拟机</code>规范不去限定<code>java线程</code>使用那种线程模型来实现。</p> <h4 id="java线程调度"><code>java线程</code>调度</h4> <blockquote><p>线程调度是系统为线程分配处理器使用权的过程</p></blockquote> <p>两种调度方式：协同式线程调度和抢占式线程调度</p> <p><code>java线程</code>调度就是使用的抢占式线程调度，每个线程由系统分配执行时间，线程的切换不由线程自身决定</p> <h4 id="java线程状态切换"><code>java线程</code>状态切换</h4> <p>6种线程状态：<code>NEW、RUNNABLE、WAITING、TIMED_WAITING、BLOCKED、 TERMINATED</code></p> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">flowchart</span> TD
a<span class="token text string">((NEW))</span><span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">start方法</span><span class="token arrow operator">--&gt;</span></span>b<span class="token text string">(RUNNABLE)</span>
b<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">wait方法</span><span class="token arrow operator">--&gt;</span></span>c<span class="token text string">(WAITING)</span>
b<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">sleep方法</span><span class="token arrow operator">--&gt;</span></span>c1<span class="token text string">(TIMED_WAITING)</span>
c1<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">-.</span><span class="token label property">notify或者notifyAll</span><span class="token arrow operator">.-&gt;</span></span>b
b<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">synchronized</span><span class="token arrow operator">--&gt;</span></span>d<span class="token text string">(BLOCKED)</span>
d<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">-.</span><span class="token label property">获取到锁</span><span class="token arrow operator">.-&gt;</span></span>b
b<span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span><span class="token label property">run结束</span><span class="token arrow operator">--&gt;</span></span>e<span class="token text string">((TERMINATED))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="二、java线程池">二、java线程池</h2> <h3 id="java线程池实现">java线程池实现</h3> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">classDiagram</span>
<span class="token keyword">class</span> Executor
<span class="token annotation important">&lt;&lt;interface&gt;&gt;</span> Executor
<span class="token keyword">class</span> ExecutorService
<span class="token annotation important">&lt;&lt;interface&gt;&gt;</span> ExecutorService
<span class="token keyword">class</span> AbstractExecutorService
<span class="token keyword">class</span> ThreadPoolExecutor

Executor<span class="token arrow operator">&lt;|--</span>ExecutorService
ExecutorService<span class="token arrow operator">&lt;|..</span>AbstractExecutorService
AbstractExecutorService<span class="token arrow operator">&lt;|--</span>ThreadPoolExecutor
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>主要接口： <code>ExecutorService</code></p> <p>实现类： <code>ThreadPoolExecutor</code></p> <h3 id="线程池执行流程">线程池执行流程</h3> <p><img src="/blog/assets/img/execute.ffff780c.jpg" alt=""></p> <h3 id="线程池工作流程">线程池工作流程</h3> <p><img src="/blog/assets/img/work.f245a591.jpg" alt=""></p> <ul><li><p>线程池状态</p> <ul><li><strong>running</strong>  运行状态，改状态下线程可以接受新的任务，也可以处理阻塞队列中的任务</li> <li><strong>shutdown</strong>  待关闭状态，不再接受新的任务，继续处理阻塞队列中的任务，当阻塞队列中的任务为空，并且工作线程数为0时，进入tidying状态</li> <li><strong>stop</strong>  停止状态，不接受新任务，也不处理阻塞队列中的任务，并且会尝试结束执行中的任务，当工作线程数为0时，进入tidying状态</li> <li><strong>tidying</strong>  整理状态，此时任务都已经执行完毕，并且没有工作线程，执行terminated方法进入terminated状态</li> <li><strong>terminated</strong>  终止状态，此时线程完全终止，并完成资源的释放</li></ul></li> <li><p>拒绝策略<br>
丢
忽视
执行任务
从队列踢出一个最先进入的任务</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>
allowCoreThreadTimeout=true  
clt变量控制状态 生效线程数、线程运行状态

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="创建线程池">创建线程池</h3> <h4 id="executors静态工厂创建线程池">Executors静态工厂创建线程池</h4> <ol><li><strong>newFixedThreadPool</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**创建一个指定工作线程数的线程池，其中参数 corePoolSize 和 maximumPoolSize 相等，阻塞队列基于LinkedBlockingQueue,具有线程池提高程序效率和节省创建线程时所耗的开销的优点。但是在线程池空闲时，即线程池中没有可运行任务时，它也不会释放工作线程，还会占用一定的系统资源; **/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li><strong>newSingleThreadExecutor</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**初始化的线程池中只有一个线程，如果该线程异常结束，会重新创建一个新的线程继续执行任务，唯一的线程可以保证所提交任务的顺序执行，内部使用LinkedBlockingQueue作为阻塞队列**/</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>
      <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                              <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                              <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              threadFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="3"><li><strong>newCachedThreadPool</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**创建一个可缓存工作线程的线程池，默认存活时间60秒，线程池的线程数可达到Integer.MAX_VALUE，即2147483647，内部使用SynchronousQueue作为阻塞队列;在没有任务执行时，当线程的空闲时间超过keepAliveTime，则工作线程将会终止，当提交新任务时，如果没有空闲线程，则创建新线程执行任务，会导致一定的系统开销  **/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>
							  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
							  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
							  threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li><strong>newScheduledThreadPool</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**初始化的线程池可以在指定的时间内周期性的执行所提交的任务，在实际的业务场景中可以使用该线程池定期的同步数据**/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span>
      <span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                                   <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="threadpoolexecutor手动创建线程池">ThreadPoolExecutor手动创建线程池</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//创建线程池</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span><span class="token comment">//核心线程数</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span><span class="token comment">//最大线程数</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span><span class="token comment">//空闲线程存活时间</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span><span class="token comment">//空闲线程存活时间单位</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span><span class="token comment">//任务队列</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span><span class="token comment">//创建线程的工厂	</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token comment">//拒绝策略)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="核心线程数分配">核心线程数分配</h4> <div class="language- extra-class"><pre><code>【两个考虑点：cpu io】
	【CPU密集】  大部分场景是纯CPU计算，本质是要提升CPU的利用率，考虑CPU在多线程之间切换耗时
	
		（线程等待时间+线程CPU时间）/线程CPU时间*CPU数目*利用率
		
		举例：【4核CPU】
		
			任务 任务执行时间 分配线程 
			500  0.2     
			1 / 0.2 = 5*4=20*利用率（0.8）=16个线程
			等待时间占比越高，需要越多线程。
		
	【IO密集】   IO操作时间相当于CPU计算时间非常长，要将硬件的性能发挥到一致
	
		最佳线程数：IO耗时/CPU耗时+1
</code></pre></div><h2 id="三、代码示例">三、代码示例</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//创建实现Callable接口的任务类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MaterialUploadTask</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MaterialUploadResult</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">MaterialUploadBean</span> bean<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ClService</span> clService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">TYwgyDzjzWs</span> ws<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MaterialUploadResult</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    	<span class="token comment">//具体业务处理逻辑</span>
        <span class="token keyword">return</span> clService<span class="token punctuation">.</span><span class="token function">uploadCl</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//创建执行类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClExecutor</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> streamMaterialUploadTask；
	<span class="token annotation punctuation">@PostConstruct</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//初始化一个线程池</span>
		streamMaterialUploadTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
		<span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;materialUploadExecutor-pool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MaterialUploadResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">asynUploadExecute</span><span class="token punctuation">(</span><span class="token class-name">StreamMaterialUploadTask</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> streamMaterialUploadTask<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//具体使用</span>
<span class="token keyword">private</span> <span class="token class-name">ClExecutor</span> clExecutor<span class="token punctuation">;</span>
<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MaterialUploadResult</span><span class="token punctuation">&gt;</span></span> uploadResultFuture <span class="token operator">=</span> clExecutor<span class="token punctuation">.</span><span class="token function">asynUploadExecute</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">MaterialUploadTask</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> clService<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/27/2022, 2:54:03 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/share/java/Java8.html">
        Java8
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.c61f9dc1.js" defer></script><script src="/blog/assets/js/2.388d52cb.js" defer></script><script src="/blog/assets/js/7.08c24d6d.js" defer></script>
  </body>
</html>
