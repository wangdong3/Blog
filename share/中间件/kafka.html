<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kafka | 文档管理</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="文档管理">
    
    <link rel="preload" href="/blog/assets/css/0.styles.d7574f63.css" as="style"><link rel="preload" href="/blog/assets/js/app.c61f9dc1.js" as="script"><link rel="preload" href="/blog/assets/js/2.388d52cb.js" as="script"><link rel="preload" href="/blog/assets/js/10.e48886a1.js" as="script"><link rel="prefetch" href="/blog/assets/js/11.0db0625b.js"><link rel="prefetch" href="/blog/assets/js/12.f1057769.js"><link rel="prefetch" href="/blog/assets/js/13.b442abea.js"><link rel="prefetch" href="/blog/assets/js/14.daba5dbf.js"><link rel="prefetch" href="/blog/assets/js/15.c8b8c48c.js"><link rel="prefetch" href="/blog/assets/js/16.7215a435.js"><link rel="prefetch" href="/blog/assets/js/17.2fc8aa9b.js"><link rel="prefetch" href="/blog/assets/js/18.616d526d.js"><link rel="prefetch" href="/blog/assets/js/19.1c4d1a0e.js"><link rel="prefetch" href="/blog/assets/js/20.29879dee.js"><link rel="prefetch" href="/blog/assets/js/21.1d2b8804.js"><link rel="prefetch" href="/blog/assets/js/22.d0629f3d.js"><link rel="prefetch" href="/blog/assets/js/23.93a8ebaf.js"><link rel="prefetch" href="/blog/assets/js/24.324df21c.js"><link rel="prefetch" href="/blog/assets/js/25.b6c9075c.js"><link rel="prefetch" href="/blog/assets/js/26.99b267df.js"><link rel="prefetch" href="/blog/assets/js/27.95b0c3cd.js"><link rel="prefetch" href="/blog/assets/js/28.d14ae9b5.js"><link rel="prefetch" href="/blog/assets/js/29.43834437.js"><link rel="prefetch" href="/blog/assets/js/3.7cefba26.js"><link rel="prefetch" href="/blog/assets/js/30.bb384616.js"><link rel="prefetch" href="/blog/assets/js/31.20f86835.js"><link rel="prefetch" href="/blog/assets/js/32.c742083f.js"><link rel="prefetch" href="/blog/assets/js/33.b2366c8c.js"><link rel="prefetch" href="/blog/assets/js/34.dd52f826.js"><link rel="prefetch" href="/blog/assets/js/35.17416a72.js"><link rel="prefetch" href="/blog/assets/js/36.ff166262.js"><link rel="prefetch" href="/blog/assets/js/4.2f1c3a5f.js"><link rel="prefetch" href="/blog/assets/js/5.4c55088b.js"><link rel="prefetch" href="/blog/assets/js/6.c9d0387c.js"><link rel="prefetch" href="/blog/assets/js/7.08c24d6d.js"><link rel="prefetch" href="/blog/assets/js/8.f72ad2ba.js"><link rel="prefetch" href="/blog/assets/js/9.c27fcf06.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d7574f63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="文档管理" class="logo"> <span class="site-name can-hide">文档管理</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  Share
</a></div><div class="nav-item"><a href="http://blog.csdn.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/wangdong3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/share/" class="nav-link router-link-active">
  Share
</a></div><div class="nav-item"><a href="http://blog.csdn.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/wangdong3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>中间件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/share/中间件/es.html" class="sidebar-link">ElasticSearch应用</a></li><li><a href="/blog/share/中间件/kafka.html" class="active sidebar-link">kafka</a></li><li><a href="/blog/share/中间件/Nginx.html" class="sidebar-link">nginx</a></li><li><a href="/blog/share/中间件/zookeeper.html" class="sidebar-link">zookeeper</a></li><li><a href="/blog/share/中间件/Redis.html" class="sidebar-link">Redis</a></li><li><a href="/blog/share/中间件/RocketMQ.html" class="sidebar-link">RocketMQ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kafka"><code>kafka</code></h1> <h2 id="前言-kafka设计">前言：<code>kafka</code>设计</h2> <ul><li><p><strong>磁盘顺序读写</strong></p> <p><code>kafka</code>的消息是顺序写到磁盘文件的末尾，以此能提升写入性能。<code>topic</code>的每个分区都是一个文件，收到消息，<code>kafka</code>会把消息插入到文件的末尾。
每个消费者对其订阅的<code>topic</code>都有一个<code>offset</code>来表示读取到了第几条数据。</p></li> <li><p><strong>页缓存</strong></p> <p>利用操作系统本身的<code>page cache</code>来优化读写性能，<code>kafka</code>的读写基于内存，速度快</p></li> <li><p><strong>零拷贝</strong></p> <p>减少应用程序与操作系统上下文切换</p></li> <li><p><strong>分区分段 + 索引</strong></p> <p><code>kafka</code> 的消息按<code>topic</code>分类存放，一个<code>topic</code>的消息又是可以存放到多个<code>partition</code>，每个分区对应一个<code>broker</code>节点，这个符合分布式系统的设计思想。
每个分区又会分段，消息实际上存放在各个分区的<code>segment</code>上，每次文件操作就是操作这个<code>segment</code>，为了进一步的优化，<code>kafka</code>为每个分段文件建立一个索引文件。</p></li></ul> <blockquote><p>这种设计提高了读取速率，同时也提高数据操作的并行度。</p></blockquote> <ul><li><p><strong>批量读写</strong></p> <p>写入消息时，启用批次写入，这样可以避免在网络中频繁网络请求，提高吞吐量；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//默认16kb，不宜过大，过大会有延迟
batch.size=16384
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><strong>批量压缩</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//设置发送消息的缓冲区大小，默认32M
buffer.memory=33554432
//开启gzip压缩，减少网络`io`损耗
compression-type: gzip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- extra-class"><pre><code>  批量读写和批量压缩都是`kafka`提高吞吐量的设计优点。
</code></pre></div></li></ul> <h2 id="kafka相关概念"><code>kafka</code>相关概念</h2> <p><img src="/blog/assets/img/kafka1.65f4770c.png" alt=""></p> <ul><li><p><strong>broker</strong>：存储消息</p></li> <li><p><strong>producer</strong>：生产者，发送消息</p></li> <li><p><strong>consumer</strong>：消费消息，完成消息的读取及后续的业务处理</p></li> <li><p><strong>consumer group</strong>：消费者组，管理一组消费者，同组消费者可以消费订阅的同一个主题的消息。</p></li> <li><p><strong>group coordinator</strong>：每个消费者组会选择一个<code>broker</code>来监控消费者组里面各个消费者的心跳情况，以及判断是否宕机，这个<code>broker</code>就是<code>coordinator</code></p> <p><code>hash(groupId)/partition</code>，找到分区所在的<code>broker</code>，作为<code>coordinator</code></p> <p><strong><code>rebalance</code></strong>：策略：</p> <p>​	（1）range策略，按照分区范围进行消费</p> <p>​	（2）round-robin，轮询</p> <p>​	（3）sticky策略，尽量不懂属于原本消费者消费的分区，把空闲多余的分区在分配给各个存活的消费者</p></li> <li><p><strong>topic</strong>（逻辑上的概念）消息按<code>topic</code>进行分类</p></li> <li><p><strong>partition</strong>（分区，这个是真实的物理概念，每个分区都在不同的服务器上），对<code>topic</code>设置多个<code>partition</code>，所有的消息都会不断地追加到<code>partition</code>日志文件的末端，且每套消息都有自己的<code>offset</code></p></li> <li><p><strong>文件存储</strong>：</p> <ul><li><code>.log</code>文件（存储消息）</li> <li><code>.index</code>文件，用来定位消息</li></ul></li> <li><p><code>offset</code> 消息相对偏移量</p></li> <li><p><strong><code>ack</code></strong>：<code>[all, -1, 0, 1]</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//0:请求发出去，不保证消息发送成功；1：leader partition写成功；-1：ISR列表里面，所有副本写入完成，这条消息才算发送成功
kafka.producer.acks=1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><strong><code>ISR</code></strong> 保持同步的副本</li></ul> <p>一个<code>leader partition</code>会维护一个<code>ISR</code>列表</p> <p>为了保证生产者发送消息成功，<code>topic</code>的每个分区在收到消息后，都要向<code>producer</code>发送<code>ack</code>消息确认，生产者收到<code>ack</code>就会发送下一个消息，否则重新发送</p> <blockquote><p><code>acks=all</code>集群副本同步主节点的消息成功，则发送<code>ack</code>，这样即使主节点挂掉，从节点也能及时选出新的主节点。</p></blockquote></li></ul> <h2 id="kafka与其他消息中间件相比-优劣势"><code>kafka</code>与其他消息中间件相比，优劣势</h2> <ul><li><p>吞吐量高。<code>tps</code>达到百万</p></li> <li><p>单机支持的队列数不能过多</p></li> <li><p>不支持消息查询</p></li> <li><p>消息回溯</p></li> <li><p>不支持<code>broker</code>端类似<code>tag</code>的消息过滤</p></li></ul> <h2 id="kafka操作指令"><code>kafka</code>操作指令</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>./kafka-topics.sh --describe --zookeeper ip:port --topic &quot;topicname&quot;
.kafka-topics.sh --zookeeper localhost:2181 --create --topic my-topic --partitions 1 --replication-factor 1 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="问题思索">问题思索</h2> <ol><li><p><code>kafka</code>消息积压如何处理？</p> <p>分析原因：</p> <p>（1）消费者服务中间出现宕机，在这段时间生产者源源不断在生产消息就会积压；</p> <p>（2）消费者服务消费能力不足，需要增多消费者服务；</p> <p>（3）消费线程触发死锁或者资源等待；</p> <p>（4）消费者每次拉取消息的量太小，导致单位时间内生产的消息比消费的的消息量小，导致消息积压，需要加大拉取消息的量；</p> <p>处理：短时间内需要扩容消费者实例数来处理积压消息</p></li> <li><p>如何保证顺序消费消息？</p> <p>（1）一个主题只创建一个分区；</p> <p>（2）生产者指定分区发消息；</p></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/20/2022, 6:41:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/share/中间件/es.html" class="prev">
        ElasticSearch应用
      </a></span> <span class="next"><a href="/blog/share/中间件/Nginx.html">
        nginx
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.c61f9dc1.js" defer></script><script src="/blog/assets/js/2.388d52cb.js" defer></script><script src="/blog/assets/js/10.e48886a1.js" defer></script>
  </body>
</html>
