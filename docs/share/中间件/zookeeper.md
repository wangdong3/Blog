# zookeeper

## 1.概念

zookeeper是一个为分布式应用提供一致性服务的的开源组件，其内部是一个 分层文件系统目录结构。

- **文件系统**

  zookeeper提供一个多层级的节点（znode）命名空间，这些节点可以设置关联的数据。在内存中维护这个**树状**的目录结构，保证高吞吐和低延迟。

  四种类型的znode

  - 持久化目录节点

    客户端与zookeeper断开连接以后，该节点依然存在

  - 持久化顺序号目录节点

    客户端与zookeeper断开连接后，该节点依然存在，只是zookeeper给该节点名称顺序编号

  - 临时目录节点

    客户端与zookeeper断开连接后，该节点被删除

  - 临时顺序号目录节点

    客户端与zookeeper断开连接后，该节点被删除，只是zookeeper给该节点名称进行顺序编号

- **通知机制**

  客户端注册监听它所关注的znode节点，zookeeper会对znode建立watcher事件，当znode发生改变时，client会收到zookeeper的通知，然后client根据znode变化作出业务的改变。

## 2.使用场景

- **配置管理**

  应用程序的配置放到zookeeper上，保存在zookeeper的某个目录节点中，然后所有相关的应用程序监听该目录节点，一旦配置信息发生变化，每个应用程序都会收到zookeeper的通知，然后从zookeeper获取新的配置信息应用到应用程序。

- **集群管理**

  监控服务的退出和加入，选举master

  所有服务约定在指定父目录下创建临时节点，然后监听父目录节点的变化信息，一旦某个服务挂掉，意味着其与zookeeper的连接断开，那么其创建的临时节点就会被删除，其他服务也会收到监控通知，某个兄弟目录被删除了。

  每个服务同时也会创建临时顺序编号目录节点，取编号最小的作为master。

- **分布式锁**

  锁服务可分为两类，保持独占，控制时序

  客户端通过创建临时节点来获取锁，获取锁之后完成业务处理会把临时节点删除；

  锁如果已经预先存在，那么所有客户就要在其下面创建临时顺序目录节点，编号最小的获得锁；

- **队列管理**

  - 同步队列

    当一个队列的成员都聚齐时，这个队列才有用，否则一直等待所有成员到达

  - 队列按照FIFO的方式进行入队和出队

    按照临时顺序目录号，进行出入队

## 3.底层原理

zookeeper的核心是原子广播，这个机制保证了各个server之间的同步。实现该机制的协议叫zab协议。有两种模式，恢复模式和广播模式；当服务启动或者leader崩溃，进入恢复模式，当leader被选出来，各个server完成了状态同步后，恢复模式结束；

为保证分布式事务的一致性，zookeeper采用递增事务id号（zxid）来标识事务。

（1）server向集群中其他服务发起询问

（2）接收询问信息，验证zxid是否一致，获取对方的id，存到自己的已询问列表中

（3）获取对方提议的leader信息，存到当前投票记录列表中

（4）统计选举结果，超过半数以上的推举为leader