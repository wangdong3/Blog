# MQ

## MQ

## 为什么使用MQ

1.服务之间的解耦

2.异步的场景

3.高并发下削峰

优点：吞吐量高

## Mq的缺点

1.服务一旦挂了，业务流程就走不完，总结来说就是服务可用性降低
2.系统复杂性增加，需要考虑一致性问题，消息的重复消费，消息可靠传输

## 消息队列高可用

集群namesvr broker

## 如何保证消息不重复消费

消息消费完，会发送确认信息，消息显示consumed_success.
意外的情况，消息消费了，但是MQ刚好重启，消息没有消费成功的状态，就会再被消费一次。消费者保证，消息的唯一性。

## 消息可靠性传输

1.生产者生产消息，可能由于网络问题，没有发送到MQ，程序会抛异常，重试机制

2.MQ的问题，服务意外挂掉 ，持久化机制，在重启后将持久化数据加载到内存

3.消费者将消息弄丢，确认机制自动关闭改为手动，只有当消息消费完成，才发送确认ack



## RocketMQ

特点：基于磁盘存储，无限积压、高吞吐、低延迟

### 存储设计

commitlog文件：建立哈希索引，存储在index文件中

consumequeue文件，commitlog文件基于topic的索引文件，以此提高根据主题检索消息的效率

在写入消息过程中追求极致的磁盘顺序写，所有主题的消息写入一个文件，即commitlog；

每一条消息身份标志：物理偏移量，即消息存储在文件中的起始位置



## kafka

特点：百万级tps

存储设计：append追加日志写入 + 稀疏哈市索引查询