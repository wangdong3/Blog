(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{437:function(s,a,n){"use strict";n.r(a);var t=n(56),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"redis"}},[s._v("Redis")]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#redis是什么"}},[s._v("Redis是什么")])]),n("li",[n("a",{attrs:{href:"#redis使用场景"}},[s._v("Redis使用场景")])]),n("li",[n("a",{attrs:{href:"#redis支持哪些数据结构"}},[s._v("Redis支持哪些数据结构")])]),n("li",[n("a",{attrs:{href:"#redis分布式锁"}},[s._v("Redis分布式锁")])]),n("li",[n("a",{attrs:{href:"#实现异步队列"}},[s._v("实现异步队列")])]),n("li",[n("a",{attrs:{href:"#同步机制-主从复制"}},[s._v("同步机制 (主从复制)")])]),n("li",[n("a",{attrs:{href:"#哨兵机制-hearts"}},[s._v("哨兵机制(♥️)")])]),n("li",[n("a",{attrs:{href:"#持久化"}},[s._v("持久化")])]),n("li",[n("a",{attrs:{href:"#常见问题"}},[s._v("常见问题")])]),n("li",[n("a",{attrs:{href:"#淘汰策略"}},[s._v("淘汰策略")])])])]),n("p"),s._v(" "),n("h2",{attrs:{id:"redis是什么"}},[s._v("Redis是什么")]),s._v(" "),n("p",[s._v("开源的，内存中的数据结构存储系统。")]),s._v(" "),n("p",[s._v("基于内存又可持久化、key-value数据库。")]),s._v(" "),n("p",[s._v("可以用作数据库、缓存和消息中间件。")]),s._v(" "),n("h2",{attrs:{id:"redis使用场景"}},[s._v("Redis使用场景")]),s._v(" "),n("ul",[n("li",[s._v("缓存，session缓存")]),s._v(" "),n("li",[s._v("消息队列")]),s._v(" "),n("li",[s._v("分布式锁")])]),s._v(" "),n("h2",{attrs:{id:"redis支持哪些数据结构"}},[s._v("Redis支持哪些数据结构")]),s._v(" "),n("ul",[n("li",[s._v("String")]),s._v(" "),n("li",[s._v("list")]),s._v(" "),n("li",[s._v("hash")]),s._v(" "),n("li",[s._v("set")]),s._v(" "),n("li",[s._v("sortedset")])]),s._v(" "),n("h2",{attrs:{id:"redis分布式锁"}},[s._v("Redis分布式锁")]),s._v(" "),n("p",[s._v("​\t1）使用set命令缓存锁")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("set key value ex time nx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("​\t2）使用lua脚本设置")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token char"}},[s._v("'setNx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KEYS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ARGV"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" then "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token char"}},[s._v("'get'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" KEYS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("ARGV"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" then "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token char"}},[s._v("'expire'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" KEYS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ARGV"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" end end\n    \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token char"}},[s._v("'get'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" KEYS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" ARGV"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" then "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token char"}},[s._v("'del'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" KEYS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" end\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("实现思想：使用setnx命令加锁，并使用expire给锁加一个超时时间，超过该时间，则自动释放锁；锁的value值为随机生成的id，释放锁时要判断下，是不是该锁。")]),s._v(" "),n("p",[s._v("使用过程中可能会出现的问题：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("（1）业务操作异常，未能走到释放锁，锁得不到释放，可能会产生死锁\n\n（2) try catch finally解决上一个问题，除程序抛异常外，程序崩溃，服务器宕机，重启等也可能会导致锁的释放没有执行\n\n（3）解决上一个问题，需要给锁设置超时时间；另外加锁，设置超时时间可能并不是原子操作，在设置超时时间时，程序崩溃，未能成功设置超时时间也可能导致死锁\n\n（4）使用lua脚本，或者set原生命令，增加ex,nx,px等参数，加锁和设置超时时间在一条命令上执行\n\n（5）高并发场景下，可能超时时间不合理，A线程业务未处理完 ，锁自动释放，B线程获得锁，开始执行业务，A线程业务执行完释放锁，会把B线程刚加的锁给删掉了，等到B线程业务处理完，释放锁时可能就会出错\n\n（6）解决上一个问题，就需要加锁时，value值设置为唯一值，释放锁时，通过这个唯一id，判断是不是该锁；超时时间的设置，在加锁成功后，启动一个守护线程，守护线程每隔三分之一超时时间就去延迟锁的超时时间（续命），业务处理完，要关闭守护线程\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h2",{attrs:{id:"实现异步队列"}},[s._v("实现异步队列")]),s._v(" "),n("p",[s._v("用List结构作为队列，rpush生产消息，当lpop没有消息时，sleep一会再重试")]),s._v(" "),n("h2",{attrs:{id:"同步机制-主从复制"}},[s._v("同步机制 (主从复制)")]),s._v(" "),n("p",[s._v("配置：")]),s._v(" "),n("p",[n("code",[s._v("slaveof <masterip> <masterport>")])]),s._v(" "),n("h2",{attrs:{id:"哨兵机制"}},[s._v("哨兵机制(♥️)")]),s._v(" "),n("ul",[n("li",[s._v("解决主从复制的缺点")]),s._v(" "),n("li",[s._v("当主节点出现故障，由Redis sentinel自动完成故障发现和转移，实现高可用")])]),s._v(" "),n("h2",{attrs:{id:"持久化"}},[s._v("持久化")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("RDB   快照")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##rdb配置相关")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#时间策略")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("900")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#文件名称")]),s._v("\ndbfilename dump.rdb\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#文件保存路径")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" ./\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果持久化出错，主进程停止写入")]),s._v("\nstop-writes-on-bgsave-error "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否对RDB文件进行压缩，默认是yes")]),s._v("\nrdbcompression "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#是否对rdb文件进行校验，默认是yes")]),s._v("\nrdbchecksum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("AOF   保存命令重新执行：包括命令的实时写入，AOF文件的重写")]),s._v(" "),n("p",[s._v("命令写入--》追加到aof_buf--》同步到磁盘AOF文件。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##aof配置相关")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#是否开启AOF")]),s._v("\nappendonly no\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# The name of the append only file (default: "appendonly.aof")')]),s._v("\nappendfilename "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly.aof"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#三种同步策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#每次接受到写命令，强制写入磁盘")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# appendfsync always")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#每秒写入一次")]),s._v("\nappendfsync everysec\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#完全依赖操作系统写入")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# appendfsync no")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在日志重写时，不进行命令追加操作，而是将其放到缓冲区里，避免与命令的追加造成DISK IO的冲突")]),s._v("\nno-appendfsync-on-rewrite no\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#当前AOF文件是上次日志重写得到AOF文件大小的两倍时，自动启动新的日志重写过程")]),s._v("\nauto-aof-rewrite-percentage "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#当前AOF文件启动新的日志重写过程的最小值，避免频繁重写")]),s._v("\nauto-aof-rewrite-min-size 64mb\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#加载aof时如果有错如何处理")]),s._v("\naof-load-truncated "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件重写策略")]),s._v("\naof-rewrite-incremental-fsync "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"常见问题"}},[s._v("常见问题")]),s._v(" "),n("ul",[n("li",[s._v("缓存雪崩  大量缓存失效，请求转到数据库，造成数据库的压力；设置失效时间点均匀分布，避免雪崩；在时间上加一个随机值，使得过期时间分散；")]),s._v(" "),n("li",[s._v("缓存穿透   命中率； 缓存未命中，查询数据库空；设置默认值放到缓存里，这样就不会继续访问数据库")]),s._v(" "),n("li",[s._v("实现消息队列，队列满了怎么办，消费不完怎么办？")])]),s._v(" "),n("h2",{attrs:{id:"淘汰策略"}},[s._v("淘汰策略")]),s._v(" "),n("ol",[n("li",[s._v("设置过期中最近最少使用")]),s._v(" "),n("li",[s._v("设置过期中将要过期的")]),s._v(" "),n("li",[s._v("设置过期中任意数")]),s._v(" "),n("li",[s._v("最近最少使用")]),s._v(" "),n("li",[s._v("任意")])])])}),[],!1,null,null,null);a.default=e.exports}}]);